#!/bin/bash

###############################################################################
# ğŸ¬ TitleTagger â€” Embed a Custom 'title' Metadata Tag into an MP4 File
#
# This script embeds a metadata title into a given MP4 file using ffmpeg.
# It creates a temporary file in /tmp, validates the tag, and replaces the
# original file only if the tag is confirmed. Cleanup is guaranteed.
#
# ğŸ’¡ Usage:
#   ./TitleTagger.sh <filename.mp4> "<title-text>"
#
# ğŸ“Œ Requirements:
#   - ffmpeg and ffprobe installed
#   - Input file must be an MP4 and writable
###############################################################################

filename="$1"
text="$2"
tempFile="/tmp/output_$$.mp4"  # âœ… Unique temporary file using PID

# ğŸ§ª Argument and file existence checks
if [[ -z "$filename" || -z "$text" ]]; then
    echo "âŒ ERROR: Missing arguments."
    echo "ğŸ”§ Usage: $0 <filename.mp4> \"<title-text>\""
    echo
    echo "ğŸ“˜ Adds a metadata 'title' to your MP4 file."
    exit 1
fi

if [[ ! -f "$filename" ]]; then
    echo "âŒ ERROR: File not found: $filename"
    exit 1
fi

echo "ğŸ”§ Adding metadata: title=\"$text\" to $filename..."
ffmpeg -loglevel quiet -i "${filename}" -c copy -movflags use_metadata_tags \
    -metadata title="${text}" -y "$tempFile"

if [[ $? -ne 0 ]]; then
    echo "âŒ ERROR: ffmpeg failed to process the file."
    rm -f "$tempFile"
    exit 1
fi

# ğŸ§¾ Verify metadata tag
addedTitle=$(ffprobe -show_format "$tempFile" -loglevel quiet | grep TAG:title | cut -d'=' -f2)

if [[ -z "$addedTitle" ]]; then
    echo "âŒ ERROR: Metadata verification failed."
    echo "ğŸš« The original file remains unchanged."
else
    echo "âœ… SUCCESS: Metadata tag verified!"
    echo "ğŸ“„ Embedded Title: \"$addedTitle\""
    mv -f "$tempFile" "$filename"
    echo "ğŸ” Final confirmation:"
    ffprobe -show_format "$filename" -loglevel quiet | grep TAG:title | cut -d'=' -f2
fi

# ğŸ§¹ Cleanup
rm -f "$tempFile"
